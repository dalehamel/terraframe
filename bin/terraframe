#! /usr/bin/env ruby

lib = File.expand_path(File.dirname(__FILE__) + '/../lib')
$LOAD_PATH.unshift(lib) if File.directory?(lib) && !$LOAD_PATH.include?(lib)

require 'logger'
require 'trollop'
require 'terraframe'
require 'awesome_print'

opts = Trollop::options do
  opt :input_file,    "Input file(s) to process into a Terraform script.",
                      :short => "f", :type => :string, :multi => true, :required => true
  opt :variable_file, "Variable file (YAML or JSON, not tfvars!).",
                      :short => "v", :type => :string, :multi => true
  opt :pretty_print,  "Pretty-prints the Terraform output.", :default => true
  opt :verbose,       "Increases logging verbosity.", :default => false
end

processor = Terraframe::Processor.new
if opts[:verbose]
  processor.logger.level = Logger::DEBUG
end
processor.logger.debug opts.inspect

output = processor.process_files(opts[:input_file], opts[:variable_file] || [])
if opts[:pretty_print]
  output = JSON.pretty_generate(JSON.parse(output))
end

processor.logger.info "Writing output to stdout."
puts output
